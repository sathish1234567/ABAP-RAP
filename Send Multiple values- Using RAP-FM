ChatGPT said:

Perfect ‚úÖ ‚Äî let‚Äôs build a complete working RAP example that shows:
üîπ How to call a custom Function Module inside RAP
üîπ How to handle multiple return values (structures, tables, messages)
üîπ How to update RAP entities and return results/messages cleanly

This is a ready-to-use ADT (Eclipse) example ‚Äî just adjust the names to your namespace.

üöÄ RAP Example ‚Äî Material Transfer Using Custom Function Module
üìò 1Ô∏è‚É£ Function Module (ZMAT_TRANSFER_CHECK)

Your custom FM returns a header, multiple item lines, and messages.

FUNCTION zmat_transfer_check.
*"----------------------------------------------------------------------
*"*"Local Interface:
*"  IMPORTING
*"     VALUE(I_SITE) TYPE WERKS_D
*"  EXPORTING
*"     VALUE(ES_HEADER) TYPE ZSTR_MAT_HEADER
*"     VALUE(ET_ITEMS)  TYPE ZTT_MAT_ITEMS
*"     VALUE(ET_RETURN) TYPE BAPIRET2_T
*"----------------------------------------------------------------------
  DATA: ls_item TYPE zstr_mat_item.

  CLEAR: es_header, et_items, et_return.

  " Dummy Header
  es_header-docnum = |DOC_{ i_site }|.
  es_header-site   = i_site.
  es_header-status = 'READY'.
  es_header-total_value = '1500'.

  " Dummy items
  DO 3 TIMES.
    ls_item-matnr = |MAT_{ sy-index }|.
    ls_item-qty   = 10 * sy-index.
    ls_item-uom   = 'EA'.
    APPEND ls_item TO et_items.
  ENDDO.

  " Dummy success message
  APPEND VALUE #( type = 'S' id = 'ZMAT' number = '001' message = |Material transfer checked successfully| )
    TO et_return.

ENDFUNCTION.

üìó 2Ô∏è‚É£ CDS View Entity (ZI_MatTransfer)

Defines the RAP root entity for the material transfer.

@EndUserText.label: 'Material Transfer Entity'
@AccessControl.authorizationCheck: #CHECK
@OData.publish: true
define root view entity ZI_MatTransfer
  as select from zmat_transfer
{
  key docnum,
  site,
  status,
  total_value
}

üìô 3Ô∏è‚É£ Behavior Definition (ZBP_MAT_TRANSFER)
managed implementation in class zbp_mat_transfer unique;
strict (2);

define behavior for ZI_MatTransfer alias MatTransfer
persistent table zmat_transfer
lock master
etag master
{
  create;
  update;
  delete;

  action checkTransfer result [1] $self;
}

üìí 4Ô∏è‚É£ Behavior Implementation Class (ZBP_MAT_TRANSFER)

Here we call the Function Module, capture multiple outputs, and update the RAP entity.

CLASS zbp_mat_transfer DEFINITION PUBLIC FINAL CREATE PUBLIC.
  PUBLIC SECTION.
    INTERFACES if_abap_behavior_handler.
ENDCLASS.


CLASS zbp_mat_transfer IMPLEMENTATION.

  METHOD checkTransfer.
    DATA: ls_header  TYPE zstr_mat_header,
          lt_items   TYPE ztt_mat_items,
          lt_return  TYPE bapiret2_t.

    LOOP AT keys ASSIGNING FIELD-SYMBOL(<key>).

      " --- Call custom FM ---
      CALL FUNCTION 'ZMAT_TRANSFER_CHECK'
        EXPORTING
          i_site    = <key>-site
        IMPORTING
          es_header = ls_header
          et_items  = lt_items
          et_return = lt_return.

      " --- Update main entity from FM header ---
      MODIFY ENTITY ZI_MatTransfer
        UPDATE FIELDS ( status total_value )
        WITH VALUE #(
          ( %tky        = <key>
            status      = ls_header-status
            total_value = ls_header-total_value )
        ).

      " --- Create or update items if needed ---
      LOOP AT lt_items ASSIGNING FIELD-SYMBOL(<item>).
        WRITE: / 'Item:', <item>-matnr, <item>-qty, <item>-uom.
        " If you have a child entity ZI_MatItems, you can create records there
      ENDLOOP.

      " --- Return multiple messages from FM ---
      LOOP AT lt_return ASSIGNING FIELD-SYMBOL(<msg>).
        APPEND VALUE #(
          %msg = new_message(
            id       = <msg>-id
            number   = <msg>-number
            severity = CONV #( <msg>-type )
            v1 = <msg>-message_v1
            v2 = <msg>-message_v2
          )
        ) TO reported-mattransfer.
      ENDLOOP.

    ENDLOOP.
  ENDMETHOD.

ENDCLASS.

üìï 5Ô∏è‚É£ Service Definition (ZSD_MAT_TRANSFER)
@EndUserText.label: 'Material Transfer Service Definition'
define service ZSD_MatTransfer {
  expose ZI_MatTransfer;
}

üìò 6Ô∏è‚É£ Service Binding (ZSB_MAT_TRANSFER)

In ADT (Eclipse):

Right-click the service definition ‚Üí New Service Binding

Type: OData V4

Name: ZSB_MAT_TRANSFER

Activate it.

This automatically exposes your RAP BO as an OData service, which can be tested in Fiori or /IWFND/MAINT_SERVICE.

‚úÖ 7Ô∏è‚É£ Expected Behavior
Step	What Happens
1Ô∏è‚É£	You create a Material Transfer record with site = 1000
2Ô∏è‚É£	You trigger the checkTransfer action
3Ô∏è‚É£	RAP calls your custom FM (ZMAT_TRANSFER_CHECK)
4Ô∏è‚É£	FM returns header, items, and messages
5Ô∏è‚É£	RAP updates entity fields (status, total_value)
6Ô∏è‚É£	All messages appear in the Fiori UI toast/log
üß© 8Ô∏è‚É£ Best Practices Summary
Topic	Best Practice
FM Call	Always call inside BIMP methods (e.g., action, determination).
No COMMIT	Don‚Äôt use COMMIT/ROLLBACK inside FM ‚Äî RAP controls it.
Multiple Returns	Capture all EXPORTING parameters and handle separately.
Message Handling	Map to reported-<entity> using new_message(...).
UI Integration	Messages appear automatically in Fiori.
‚ö° Optional: CDS UI Annotations

To make it pretty in Fiori:

@UI.headerInfo: { typeName: 'Material Transfer', title: { value: 'docnum' } }
@UI.lineItem: [ { position: 10, value: 'docnum', label: 'Document' },
                { position: 20, value: 'site', label: 'Site' },
                { position: 30, value: 'status', label: 'Status' },
                { position: 40, value: 'total_value', label: 'Total Value' } ]
@UI.selectionField: [ { position: 10, value: 'site' } ]
define root view entity ZI_MatTransfer as select from zmat_transfer {
  key docnum,
  site,
  status,
  total_value
}

üéØ Result

‚úÖ You can call a custom Function Module

‚úÖ Retrieve multiple output tables

‚úÖ Update the RAP entity dynamically

‚úÖ Send messages to the Fiori UI

‚úÖ Keep everything transaction-safe under RAP control

Would you like me to include the child entity (ZI_MatItems) part as well ‚Äî so the FM‚Äôs returned item table automatically populates a sub-entity in the same RAP BO (1:n relationship)?
That would make this example fully end-to-end (header + item + FM integration).
